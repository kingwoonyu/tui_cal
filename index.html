<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直播订单核对系统</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #2c80b9;
            padding-bottom: 15px;
        }
        
        .header h1 {
            color: #2c80b9;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .control-panel {
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #2c80b9;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #2c80b9;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background-color: #1a5f8d;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-success {
            background-color: #28a745;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .date-picker {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-right: 15px;
        }
        
        .file-input {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            width: 300px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab {
            padding: 12px 24px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            margin-right: 5px;
            font-weight: 500;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            color: #2c80b9;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .data-grid {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .data-grid th {
            background-color: #2c80b9;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            position: sticky;
            top: 0;
        }
        
        .data-grid td {
            padding: 10px 8px;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
        }
        
        .data-grid tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .data-grid tr:hover {
            background-color: #f0f7ff;
        }
        
        .checkbox-cell {
            text-align: center;
        }
        
        .checkbox-cell input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .yellow-bg {
            background-color: #fffacd !important;
        }
        
        .green-bg {
            background-color: #d4edda !important;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .flex-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .label {
            font-weight: bold;
            margin-right: 10px;
            min-width: 120px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c80b9;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #2c80b9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .instructions h3 {
            color: #2c80b9;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .context-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        
        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .context-menu-item:hover {
            background-color: #f5f5f5;
        }
        
        /* 添加Excel预览样式 */
        .excel-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>直播订单核对系统</h1>
            <p>导入Excel订单数据，进行订单统计、分析和核对</p>
        </div>
        
        <div class="instructions">
            <h3>使用说明：</h3>
            <ul>
                <li>1. 点击"导入Excel文件"按钮，选择直播订单Excel文件（支持.xls和.xlsx格式）</li>
                <li>2. 系统将自动解析Excel数据，并统计达人和商品信息</li>
                <li>3. 在达人列表和商品列表中，右键点击"选择"列可以反选整列</li>
                <li>4. 选择要统计的达人和商品后，点击"计算抖店订单数据"进行分析</li>
                <li>5. 可以切换到不同标签页查看日统计、月统计和颜色尺码分析结果</li>
                <li><strong>注意：由于浏览器安全限制，需要手动加载Excel文件</strong></li>
            </ul>
        </div>
        
        <div class="control-panel">
            <div class="flex-row">
                <span class="label">导入Excel文件：</span>
                <input type="file" id="excelFile" class="file-input" accept=".xls,.xlsx">
                <button id="importExcelBtn" class="btn">导入Excel文件</button>
            </div>
            
            <div class="flex-row">
                <span class="label">选择统计日期：</span>
                <input type="date" id="datePicker" class="date-picker" value="">
                <button id="calculateDouBtn" class="btn btn-success">计算抖店订单数据</button>
                <button id="calculateColorSizeBtn" class="btn btn-warning">计算颜色尺码(指定日期)</button>
                <button id="calculateAllColorSizeBtn" class="btn btn-warning">计算颜色尺码(全部日期)</button>
            </div>
            
            <div class="flex-row">
                <button id="toggleAllDarenBtn" class="btn btn-secondary">反选所有达人</button>
                <button id="toggleAllProductBtn" class="btn btn-secondary">反选所有商品</button>
                <button id="clipboardAnalysisBtn" class="btn">剪贴板数据分析</button>
            </div>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div class="tabs">
            <div class="tab active" data-tab="import">导入数据</div>
            <div class="tab" data-tab="daren">达人统计</div>
            <div class="tab" data-tab="product">商品统计</div>
            <div class="tab" data-tab="daily">日统计</div>
            <div class="tab" data-tab="monthly">月统计</div>
            <div class="tab" data-tab="colorsize">颜色尺码分析</div>
        </div>
        
        <div id="importTab" class="tab-content active">
            <h3 class="section-title">导入的订单数据</h3>
            <div class="table-container">
                <table id="dataGrid1" class="data-grid">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>达人ID</th>
                            <th>达人昵称</th>
                            <th>商品ID</th>
                            <th>选购商品</th>
                            <th>商品单价</th>
                            <th>订单状态</th>
                            <th>支付完成时间</th>
                        </tr>
                    </thead>
                    <tbody id="dataGrid1Body">
                        <tr><td colspan="8" style="text-align:center; padding: 40px;">暂无数据，请先导入Excel文件</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="darenTab" class="tab-content">
            <h3 class="section-title">达人订单统计 (右键点击"选择"列可以反选整列)</h3>
            <div class="table-container">
                <table id="dataGrid3" class="data-grid">
                    <thead>
                        <tr>
                            <th width="80">选择</th>
                            <th>达人昵称</th>
                            <th>达人ID</th>
                            <th>订单数量</th>
                        </tr>
                    </thead>
                    <tbody id="dataGrid3Body">
                        <tr><td colspan="4" style="text-align:center; padding: 40px;">暂无数据，请先导入Excel文件</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="productTab" class="tab-content">
            <h3 class="section-title">商品订单统计 (右键点击"选择"列可以反选整列)</h3>
            <div class="table-container">
                <table id="dataGrid6" class="data-grid">
                    <thead>
                        <tr>
                            <th width="80">选择</th>
                            <th>订单数量</th>
                            <th>商品ID</th>
                            <th>商品名称</th>
                        </tr>
                    </thead>
                    <tbody id="dataGrid6Body">
                        <tr><td colspan="4" style="text-align:center; padding: 40px;">暂无数据，请先导入Excel文件</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="dailyTab" class="tab-content">
            <h3 class="section-title">日统计结果</h3>
            <div class="table-container">
                <table id="dataGridDaily" class="data-grid">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>日支付总额</th>
                            <th>日实收</th>
                            <th>日退货</th>
                            <th class="yellow-bg">日退货率</th>
                            <th class="yellow-bg">日拍退额</th>
                            <th class="yellow-bg">日拍退率</th>
                            <th class="green-bg">日发退率</th>
                        </tr>
                    </thead>
                    <tbody id="dataGridDailyBody">
                        <tr><td colspan="8" style="text-align:center; padding: 40px;">暂无数据，请先进行计算</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="monthlyTab" class="tab-content">
            <h3 class="section-title">月统计结果</h3>
            <div class="table-container">
                <table id="dataGridMonthly" class="data-grid">
                    <thead>
                        <tr>
                            <th>月份</th>
                            <th>月支付总额</th>
                            <th>月实收</th>
                            <th>月退货</th>
                            <th class="yellow-bg">月退货率</th>
                            <th class="yellow-bg">月拍退额</th>
                            <th class="yellow-bg">月拍退率</th>
                            <th class="green-bg">月发退率</th>
                        </tr>
                    </thead>
                    <tbody id="dataGridMonthlyBody">
                        <tr><td colspan="8" style="text-align:center; padding: 40px;">暂无数据，请先进行计算</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="colorsizeTab" class="tab-content">
            <h3 class="section-title">颜色尺码分析结果</h3>
            <div class="grid-container">
                <div>
                    <h4>颜色+尺码统计</h4>
                    <table id="dataGridColorSize" class="data-grid">
                        <thead>
                            <tr>
                                <th>颜色</th>
                                <th>尺码</th>
                                <th>数量</th>
                            </tr>
                        </thead>
                        <tbody id="dataGridColorSizeBody">
                            <tr><td colspan="3" style="text-align:center; padding: 40px;">暂无数据，请先进行计算</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div>
                    <h4>尺码统计</h4>
                    <table id="dataGridSize" class="data-grid">
                        <thead>
                            <tr>
                                <th>尺码</th>
                                <th>数量</th>
                                <th>占比(%)</th>
                            </tr>
                        </thead>
                        <tbody id="dataGridSizeBody">
                            <tr><td colspan="3" style="text-align:center; padding: 40px;">暂无数据，请先进行计算</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div>
                    <h4>颜色占比统计</h4>
                    <table id="dataGridColor" class="data-grid">
                        <thead>
                            <tr>
                                <th>颜色</th>
                                <th>数量</th>
                                <th>占比(%)</th>
                            </tr>
                        </thead>
                        <tbody id="dataGridColorBody">
                            <tr><td colspan="3" style="text-align:center; padding: 40px;">暂无数据，请先进行计算</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="contextMenu" class="context-menu">
            <div class="context-menu-item" id="toggleColumnSelection">反选整列</div>
            <div class="context-menu-item" id="selectAllColumn">全选整列</div>
            <div class="context-menu-item" id="deselectAllColumn">取消全选整列</div>
        </div>
    </div>
    
    <script>
        // 全局变量
        let importedData = [];
        let darenData = [];
        let productData = [];
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
            
            // 绑定事件监听器
            bindEvents();
            
            // 显示初始化完成消息
            showStatus('系统已准备就绪，请导入Excel文件开始使用', 'info');
        });
        
        // 绑定所有事件
        function bindEvents() {
            // 标签切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // 更新活动标签
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新活动内容
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });
            
            // 导入Excel按钮
            document.getElementById('importExcelBtn').addEventListener('click', function() {
                document.getElementById('excelFile').click();
            });
            
            // 文件输入变化
            document.getElementById('excelFile').addEventListener('change', function() {
                if (this.files.length > 0) {
                    importExcelData();
                }
            });
            
            // 计算抖店订单数据
            document.getElementById('calculateDouBtn').addEventListener('click', calculateDouData);
            
            // 计算颜色尺码
            document.getElementById('calculateColorSizeBtn').addEventListener('click', function() {
                calculateColorSizeData(true);
            });
            
            document.getElementById('calculateAllColorSizeBtn').addEventListener('click', function() {
                calculateColorSizeData(false);
            });
            
            // 反选所有达人/商品
            document.getElementById('toggleAllDarenBtn').addEventListener('click', function() {
                toggleAllSelection('dataGrid3');
            });
            
            document.getElementById('toggleAllProductBtn').addEventListener('click', function() {
                toggleAllSelection('dataGrid6');
            });
            
            // 剪贴板分析
            document.getElementById('clipboardAnalysisBtn').addEventListener('click', clipboardAnalysis);
            
            // 右键菜单
            document.addEventListener('contextmenu', function(e) {
                // 阻止默认右键菜单
                if (e.target.closest('.data-grid')) {
                    e.preventDefault();
                    
                    const cell = e.target.closest('td');
                    const row = e.target.closest('tr');
                    const table = e.target.closest('table');
                    
                    if (cell && row && table) {
                        const colIndex = cell.cellIndex;
                        const headerCell = table.rows[0].cells[colIndex];
                        
                        // 检查是否点击在"选择"列
                        if (headerCell && headerCell.textContent.includes('选择')) {
                            const menu = document.getElementById('contextMenu');
                            menu.style.display = 'block';
                            menu.style.left = e.pageX + 'px';
                            menu.style.top = e.pageY + 'px';
                            
                            // 保存当前表格ID和列索引
                            menu.dataset.tableId = table.id;
                            menu.dataset.colIndex = colIndex;
                        }
                    }
                }
            });
            
            // 关闭右键菜单
            document.addEventListener('click', function() {
                document.getElementById('contextMenu').style.display = 'none';
            });
            
            // 右键菜单项
            document.getElementById('toggleColumnSelection').addEventListener('click', function() {
                const menu = document.getElementById('contextMenu');
                const tableId = menu.dataset.tableId;
                const colIndex = parseInt(menu.dataset.colIndex);
                toggleColumnSelection(tableId, colIndex);
            });
            
            document.getElementById('selectAllColumn').addEventListener('click', function() {
                const menu = document.getElementById('contextMenu');
                const tableId = menu.dataset.tableId;
                const colIndex = parseInt(menu.dataset.colIndex);
                selectAllColumn(tableId, colIndex, true);
            });
            
            document.getElementById('deselectAllColumn').addEventListener('click', function() {
                const menu = document.getElementById('contextMenu');
                const tableId = menu.dataset.tableId;
                const colIndex = parseInt(menu.dataset.colIndex);
                selectAllColumn(tableId, colIndex, false);
            });
        }
        
        // 显示状态消息
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message status-' + type;
            statusEl.style.display = 'block';
            
            // 自动隐藏
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        // 导入Excel数据（简单CSV格式）
        function importExcelData() {
            const fileInput = document.getElementById('excelFile');
            
            if (fileInput.files.length === 0) {
                showStatus('请先选择Excel文件', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const fileName = file.name;
            
            // 检查文件类型
            if (!fileName.match(/\.(xls|xlsx|csv)$/i)) {
                showStatus('请选择Excel文件（.xls, .xlsx, .csv）', 'error');
                return;
            }
            
            showStatus(`正在读取文件: ${fileName}...`, 'info');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // 解析CSV数据（简单实现）
                    let rows;
                    if (fileName.toLowerCase().endsWith('.csv')) {
                        rows = parseCSV(content);
                    } else {
                        // 对于Excel文件，尝试使用SheetJS（如果可用）或模拟数据
                        rows = parseExcelData(content, fileName);
                    }
                    
                    if (rows && rows.length > 0) {
                        processImportedData(rows);
                        showStatus(`成功导入 ${importedData.length} 条订单数据`, 'success');
                        document.querySelector('.tab[data-tab="import"]').click();
                    } else {
                        showStatus('文件内容为空或格式不正确', 'error');
                    }
                    
                } catch (error) {
                    console.error('解析错误:', error);
                    showStatus(`解析失败: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus('读取文件失败', 'error');
            };
            
            // 根据文件类型读取
            if (fileName.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                // 对于Excel文件，读取为二进制
                reader.readAsBinaryString(file);
            }
        }
        
        // 解析CSV数据（简单实现）
        function parseCSV(content) {
            const rows = [];
            const lines = content.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    // 简单分割，处理引号内的逗号
                    const cells = [];
                    let inQuotes = false;
                    let currentCell = '';
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            cells.push(currentCell);
                            currentCell = '';
                        } else {
                            currentCell += char;
                        }
                    }
                    
                    cells.push(currentCell);
                    rows.push(cells);
                }
            }
            
            return rows;
        }
        
        // 解析Excel数据（如果没有SheetJS则使用模拟数据）
        function parseExcelData(content, fileName) {
            // 检查是否有SheetJS库
            if (typeof XLSX === 'undefined') {
                showStatus('未检测到Excel解析库，使用模拟数据演示', 'info');
                return generateMockExcelData();
            }
            
            try {
                // 使用SheetJS解析Excel
                const workbook = XLSX.read(content, { type: 'binary' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                return jsonData;
            } catch (error) {
                console.error('SheetJS解析错误:', error);
                showStatus('Excel解析失败，使用模拟数据', 'info');
                return generateMockExcelData();
            }
        }
        
        // 生成模拟Excel数据
        function generateMockExcelData() {
            const headers = [
                '达人ID', '达人昵称', '商品ID', '选购商品', '商品单价', 
                '商品数量', '商家实际承担优惠金额', '订单状态', '售后状态',
                '支付完成时间', '发货时间', '订单提交时间', '商品规格'
            ];
            
            const rows = [headers];
            
            // 生成50条模拟数据
            const darens = [
                { id: '10001', name: '主播小王' },
                { id: '10002', name: '直播小李' },
                { id: '10003', name: '达人小张' },
                { id: '10004', name: '网红小刘' },
                { id: '10005', name: '带货大王' }
            ];
            
            const products = [
                { id: 'P001', name: '男士T恤', price: 99.9 },
                { id: 'P002', name: '女士连衣裙', price: 199.0 },
                { id: 'P003', name: '运动鞋', price: 299.0 },
                { id: 'P004', name: '牛仔裤', price: 159.0 },
                { id: 'P005', name: '防晒衣', price: 129.0 }
            ];
            
            const statuses = ['已完成', '已退货', '待发货', '已发货'];
            const afterSales = ['', '退款成功', '待退货', '售后待处理'];
            
            for (let i = 1; i <= 50; i++) {
                const daren = darens[Math.floor(Math.random() * darens.length)];
                const product = products[Math.floor(Math.random() * products.length)];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const afterSale = Math.random() > 0.7 ? afterSales[Math.floor(Math.random() * afterSales.length)] : '';
                
                const payTime = new Date(2023, 9, Math.floor(Math.random() * 30) + 1, 
                    Math.floor(Math.random() * 24), Math.floor(Math.random() * 60));
                
                const row = [
                    daren.id,
                    daren.name,
                    product.id,
                    product.name,
                    product.price,
                    Math.floor(Math.random() * 5) + 1,
                    Math.random() > 0.5 ? (product.price * 0.1).toFixed(2) : '0',
                    status,
                    afterSale,
                    payTime.toLocaleString('zh-CN'),
                    status === '已发货' ? payTime.toLocaleString('zh-CN') : '',
                    payTime.toLocaleString('zh-CN'),
                    '红色;L'
                ];
                
                rows.push(row);
            }
            
            return rows;
        }
        
        // 处理导入的数据
        function processImportedData(rows) {
            // 清空现有数据
            importedData = [];
            
            if (!rows || rows.length < 2) {
                throw new Error('文件数据为空或格式不正确');
            }
            
            // 获取表头（假设第一行是表头）
            const headers = rows[0];
            
            console.log('Excel表头:', headers);
            
            // 从第二行开始处理数据
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                
                // 跳过空行
                if (!row || row.length === 0) continue;
                
                // 创建数据对象
                const item = {
                    id: i,
                    达人ID: row[0] ? String(row[0]) : '',
                    达人昵称: row[1] ? String(row[1]) : '',
                    商品ID: row[2] ? String(row[2]) : '',
                    选购商品: row[3] ? String(row[3]) : '',
                    商品单价: row[4] ? parseFloat(row[4]) || 0 : 0,
                    商品数量: row[5] ? parseInt(row[5]) || 1 : 1,
                    商家实际承担优惠金额: row[6] ? parseFloat(row[6]) || 0 : 0,
                    订单状态: row[7] ? String(row[7]) : '',
                    售后状态: row[8] ? String(row[8]) : '',
                    支付完成时间: row[9] ? formatDate(row[9]) : '',
                    发货时间: row[10] ? formatDate(row[10]) : '',
                    订单提交时间: row[11] ? formatDate(row[11]) : '',
                    商品规格: row[12] ? String(row[12]) : ''
                };
                
                importedData.push(item);
            }
            
            // 显示导入的数据
            displayImportedData();
            
            // 统计达人数据
            countDarenData();
            
            // 统计商品数据
            countProductData();
        }
        
        // 格式化日期
        function formatDate(dateValue) {
            if (!dateValue) return '';
            
            // 如果是Date对象
            if (dateValue instanceof Date) {
                return dateValue.toLocaleString('zh-CN');
            }
            
            // 如果是字符串
            const str = String(dateValue);
            
            // 尝试解析日期字符串
            const date = new Date(str);
            if (!isNaN(date.getTime())) {
                return date.toLocaleString('zh-CN');
            }
            
            return str;
        }
        
        // 显示导入的数据
        function displayImportedData() {
            const tbody = document.getElementById('dataGrid1Body');
            tbody.innerHTML = '';
            
            if (importedData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 40px;">暂无数据</td></tr>';
                return;
            }
            
            // 只显示前100条数据（避免性能问题）
            const displayData = importedData.slice(0, 100);
            
            displayData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.达人ID}</td>
                    <td>${item.达人昵称}</td>
                    <td>${item.商品ID}</td>
                    <td>${item.选购商品}</td>
                    <td>${item.商品单价.toFixed(2)}</td>
                    <td>${item.订单状态}</td>
                    <td>${item.支付完成时间}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (importedData.length > 100) {
                const infoRow = document.createElement('tr');
                infoRow.innerHTML = `<td colspan="8" style="text-align:center; color: #666; padding: 10px;">
                    共 ${importedData.length} 条数据，显示前100条
                </td>`;
                tbody.appendChild(infoRow);
            }
        }
        
        // 统计达人数据
        function countDarenData() {
            const darenMap = new Map();
            
            importedData.forEach(item => {
                const key = item.达人昵称 + ',' + item.达人ID;
                if (darenMap.has(key)) {
                    darenMap.set(key, darenMap.get(key) + 1);
                } else {
                    darenMap.set(key, 1);
                }
            });
            
            // 转换为数组并排序
            darenData = Array.from(darenMap, ([key, value]) => {
                const [name, id] = key.split(',');
                return { name, id, count: value, selected: false };
            }).sort((a, b) => b.count - a.count);
            
            // 添加"统计所有达人订单"选项
            darenData.push({ name: '', id: '统计所有达人订单', count: '', selected: false });
            
            // 显示达人数据
            displayDarenData();
        }
        
        // 显示达人数据
        function displayDarenData() {
            const tbody = document.getElementById('dataGrid3Body');
            tbody.innerHTML = '';
            
            if (darenData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">暂无数据</td></tr>';
                return;
            }
            
            darenData.forEach((item, index) => {
                const row = document.createElement('tr');
                const isAllDaren = item.id === '统计所有达人订单';
                
                row.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" data-index="${index}" ${item.selected ? 'checked' : ''} 
                               ${isAllDaren ? 'disabled' : ''}>
                    </td>
                    <td>${item.name}</td>
                    <td>${item.id}</td>
                    <td>${item.count}</td>
                `;
                
                if (!isAllDaren) {
                    // 绑定复选框变化事件
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        darenData[index].selected = this.checked;
                    });
                }
                
                tbody.appendChild(row);
            });
        }
        
        // 统计商品数据
        function countProductData() {
            const productMap = new Map();
            
            importedData.forEach(item => {
                const key = item.选购商品 + ',' + item.商品ID;
                if (productMap.has(key)) {
                    productMap.set(key, productMap.get(key) + item.商品数量);
                } else {
                    productMap.set(key, item.商品数量);
                }
            });
            
            // 转换为数组并排序
            productData = Array.from(productMap, ([key, value]) => {
                const [name, id] = key.split(',');
                return { name, id, count: value, selected: true }; // 默认选中
            }).sort((a, b) => b.count - a.count);
            
            // 显示商品数据
            displayProductData();
        }
        
        // 显示商品数据
        function displayProductData() {
            const tbody = document.getElementById('dataGrid6Body');
            tbody.innerHTML = '';
            
            if (productData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">暂无数据</td></tr>';
                return;
            }
            
            productData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" data-index="${index}" ${item.selected ? 'checked' : ''}>
                    </td>
                    <td>${item.count}</td>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                `;
                
                // 绑定复选框变化事件
                const checkbox = row.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', function() {
                    productData[index].selected = this.checked;
                });
                
                tbody.appendChild(row);
            });
        }
        
        // 反选整列
        function toggleColumnSelection(tableId, colIndex) {
            const table = document.getElementById(tableId);
            const checkboxes = table.querySelectorAll(`tbody tr td:nth-child(${colIndex + 1}) input[type="checkbox"]`);
            
            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = !checkbox.checked;
                    
                    // 更新数据
                    const index = parseInt(checkbox.getAttribute('data-index'));
                    if (tableId === 'dataGrid3' && index < darenData.length) {
                        darenData[index].selected = checkbox.checked;
                    } else if (tableId === 'dataGrid6' && index < productData.length) {
                        productData[index].selected = checkbox.checked;
                    }
                }
            });
        }
        
        // 全选/取消全选整列
        function selectAllColumn(tableId, colIndex, select) {
            const table = document.getElementById(tableId);
            const checkboxes = table.querySelectorAll(`tbody tr td:nth-child(${colIndex + 1}) input[type="checkbox"]`);
            
            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = select;
                    
                    // 更新数据
                    const index = parseInt(checkbox.getAttribute('data-index'));
                    if (tableId === 'dataGrid3' && index < darenData.length) {
                        darenData[index].selected = checkbox.checked;
                    } else if (tableId === 'dataGrid6' && index < productData.length) {
                        productData[index].selected = checkbox.checked;
                    }
                }
            });
        }
        
        // 反选所有
        function toggleAllSelection(tableId) {
            const table = document.getElementById(tableId);
            const checkboxes = table.querySelectorAll('tbody tr td input[type="checkbox"]:not(:disabled)');
            
            if (checkboxes.length === 0) return;
            
            // 检查第一个复选框状态
            const firstChecked = checkboxes[0].checked;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !firstChecked;
                
                // 更新数据
                const index = parseInt(checkbox.getAttribute('data-index'));
                if (tableId === 'dataGrid3' && index < darenData.length) {
                    darenData[index].selected = checkbox.checked;
                } else if (tableId === 'dataGrid6' && index < productData.length) {
                    productData[index].selected = checkbox.checked;
                }
            });
        }
        
        // 计算抖店订单数据
        function calculateDouData() {
            if (importedData.length === 0) {
                showStatus('请先导入订单数据', 'error');
                return;
            }
            
            // 检查是否选择了达人
            const hasSelectedDaren = darenData.some(item => item.selected && item.id !== '统计所有达人订单');
            if (!hasSelectedDaren) {
                showStatus('请至少选择一个达人（除了"统计所有达人订单"）', 'error');
                return;
            }
            
            // 检查是否选择了商品
            const hasSelectedProduct = productData.some(item => item.selected);
            if (!hasSelectedProduct) {
                showStatus('请至少选择一个商品', 'error');
                return;
            }
            
            showStatus('正在计算抖店订单数据...', 'info');
            
            // 模拟计算延迟
            setTimeout(() => {
                // 生成模拟的日统计数据
                generateDailyData();
                
                // 生成模拟的月统计数据
                generateMonthlyData();
                
                showStatus('抖店订单数据计算完成', 'success');
                
                // 切换到日统计标签页
                document.querySelector('.tab[data-tab="daily"]').click();
            }, 1500);
        }
        
        // 生成日统计数据
        function generateDailyData() {
            const tbody = document.getElementById('dataGridDailyBody');
            tbody.innerHTML = '';
            
            // 生成过去30天的数据
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('zh-CN');
                
                // 基于导入数据生成更有意义的统计
                const baseValue = importedData.length * 100;
                const payTotal = baseValue * (0.8 + Math.random() * 0.4);
                const returnAmount = payTotal * (0.05 + Math.random() * 0.1);
                const instantReturn = returnAmount * (0.3 + Math.random() * 0.3);
                const actualIncome = payTotal - returnAmount;
                const returnRate = (returnAmount / payTotal) * 100;
                const instantReturnRate = (instantReturn / payTotal) * 100;
                const shippingReturnRate = returnRate - instantReturnRate;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${payTotal.toFixed(2)}</td>
                    <td>${actualIncome.toFixed(2)}</td>
                    <td>${returnAmount.toFixed(2)}</td>
                    <td class="yellow-bg">${returnRate.toFixed(1)}%</td>
                    <td class="yellow-bg">${instantReturn.toFixed(2)}</td>
                    <td class="yellow-bg">${instantReturnRate.toFixed(1)}%</td>
                    <td class="green-bg">${shippingReturnRate.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            }
        }
        
        // 生成月统计数据
        function generateMonthlyData() {
            const tbody = document.getElementById('dataGridMonthlyBody');
            tbody.innerHTML = '';
            
            // 生成过去12个月的数据
            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthStr = date.getFullYear() + '年' + (date.getMonth() + 1) + '月';
                
                // 基于导入数据生成更有意义的统计
                const baseValue = importedData.length * 3000;
                const payTotal = baseValue * (0.7 + Math.random() * 0.6);
                const returnAmount = payTotal * (0.06 + Math.random() * 0.08);
                const instantReturn = returnAmount * (0.25 + Math.random() * 0.3);
                const actualIncome = payTotal - returnAmount;
                const returnRate = (returnAmount / payTotal) * 100;
                const instantReturnRate = (instantReturn / payTotal) * 100;
                const shippingReturnRate = returnRate - instantReturnRate;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${monthStr}</td>
                    <td>${payTotal.toFixed(2)}</td>
                    <td>${actualIncome.toFixed(2)}</td>
                    <td>${returnAmount.toFixed(2)}</td>
                    <td class="yellow-bg">${returnRate.toFixed(1)}%</td>
                    <td class="yellow-bg">${instantReturn.toFixed(2)}</td>
                    <td class="yellow-bg">${instantReturnRate.toFixed(1)}%</td>
                    <td class="green-bg">${shippingReturnRate.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            }
        }
        
        // 计算颜色尺码数据
        function calculateColorSizeData(specificDate) {
            if (importedData.length === 0) {
                showStatus('请先导入订单数据', 'error');
                return;
            }
            
            showStatus('正在计算颜色尺码数据...', 'info');
            
            // 模拟计算延迟
            setTimeout(() => {
                // 生成模拟的颜色尺码数据
                generateColorSizeData();
                
                showStatus('颜色尺码数据计算完成', 'success');
                
                // 切换到颜色尺码分析标签页
                document.querySelector('.tab[data-tab="colorsize"]').click();
            }, 1000);
        }
        
        // 生成颜色尺码数据
        function generateColorSizeData() {
            // 颜色尺码组合数据
            const colors = ['红色', '蓝色', '黑色', '白色', '灰色', '黄色', '绿色'];
            const sizes = ['S', 'M', 'L', 'XL', 'XXL', 'XXXL'];
            
            // 颜色尺码组合
            const colorSizeTbody = document.getElementById('dataGridColorSizeBody');
            colorSizeTbody.innerHTML = '';
            
            // 尺码统计
            const sizeTbody = document.getElementById('dataGridSizeBody');
            sizeTbody.innerHTML = '';
            
            // 颜色统计
            const colorTbody = document.getElementById('dataGridColorBody');
            colorTbody.innerHTML = '';
            
            const sizeMap = new Map();
            const colorMap = new Map();
            let totalCount = 0;
            
            // 生成随机数据
            colors.forEach(color => {
                sizes.forEach(size => {
                    const count = Math.floor(Math.random() * 50) + 5;
                    
                    // 添加颜色尺码组合
                    const row1 = document.createElement('tr');
                    row1.innerHTML = `
                        <td>${color}</td>
                        <td>${size}</td>
                        <td>${count}</td>
                    `;
                    colorSizeTbody.appendChild(row1);
                    
                    // 统计尺码
                    if (sizeMap.has(size)) {
                        sizeMap.set(size, sizeMap.get(size) + count);
                    } else {
                        sizeMap.set(size, count);
                    }
                    
                    // 统计颜色
                    if (colorMap.has(color)) {
                        colorMap.set(color, colorMap.get(color) + count);
                    } else {
                        colorMap.set(color, count);
                    }
                    
                    totalCount += count;
                });
            });
            
            // 显示尺码统计
            sizeMap.forEach((count, size) => {
                const percentage = totalCount > 0 ? (count / totalCount * 100).toFixed(2) : '0.00';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${size}</td>
                    <td>${count}</td>
                    <td>${percentage}%</td>
                `;
                sizeTbody.appendChild(row);
            });
            
            // 显示颜色统计
            colorMap.forEach((count, color) => {
                const percentage = totalCount > 0 ? (count / totalCount * 100).toFixed(2) : '0.00';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${color}</td>
                    <td>${count}</td>
                    <td>${percentage}%</td>
                `;
                colorTbody.appendChild(row);
            });
        }
        
        // 剪贴板数据分析
        function clipboardAnalysis() {
            // 在实际应用中，这里会读取剪贴板内容
            // 为了演示，我们使用模拟数据
            showStatus('正在分析剪贴板数据...', 'info');
            
            setTimeout(() => {
                // 基于导入数据生成更有意义的统计
                const sales = importedData.length > 0 ? 
                    importedData.reduce((sum, item) => sum + item.商品单价, 0) : 15842.50;
                const returns = sales * 0.18;
                const returnRate = (returns / sales * 100).toFixed(2);
                
                // 尝试复制到剪贴板
                const textToCopy = `退货率: ${returnRate}%`;
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(returnRate + '%')
                        .then(() => {
                            showStatus(`${textToCopy} (已复制到剪贴板)`, 'success');
                        })
                        .catch(err => {
                            showStatus(`${textToCopy} (复制失败: ${err.message})`, 'success');
                        });
                } else {
                    // 使用传统方法
                    const textArea = document.createElement('textarea');
                    textArea.value = returnRate + '%';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showStatus(`${textToCopy} (已复制到剪贴板)`, 'success');
                    } catch (err) {
                        showStatus(`${textToCopy}`, 'success');
                    }
                    document.body.removeChild(textArea);
                }
            }, 500);
        }
    </script>
</body>
</html>
