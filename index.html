<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç›´æ’­è®¢å•é€€è´§ç‡è®¡ç®—ç³»ç»Ÿ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <style>
        :root {
            --primary-bg: #22AF4C;
            --secondary-bg: #7F2CA5;
            --border-color: #ccc;
            --font-family: "OPPO Sans 4.0", "Segoe UI", Tahoma, sans-serif;
        }

        body {
            font-family: var(--font-family);
            font-size: 14px;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* å·¥å…·æ  */
        .toolbar {
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            border: none;
            padding: 6px 15px;
            cursor: pointer;
            border-radius: 2px;
            color: white;
        }

        .btn-import { background-color: var(--primary-bg); width: 260px; }
        .btn-calc { background-color: var(--secondary-bg); font-weight: bold; }
        .btn-gray { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; }

        #status-label { color: blue; margin-left: 20px; }

        /* ä¸»ä½“å¸ƒå±€ */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 10px;
            gap: 15px;
        }

        /* å·¦ä¾§ç­›é€‰åŒº */
        .sidebar {
            width: 450px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tree-container {
            flex: 1;
            border: 1px solid var(--border-color);
            overflow: auto;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            position: sticky;
            top: 0;
            background: #eee;
            z-index: 1;
            border-bottom: 1px solid #ccc;
            padding: 5px;
            font-weight: bold;
        }

        td {
            padding: 4px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
        }

        tr:hover { background: #f5f5f5; }

        /* å³ä¾§å±•ç¤ºåŒº */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 8px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
        }

        .tab.active {
            border-color: var(--border-color);
            background: white;
            margin-bottom: -1px;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            flex: 1;
            border: 1px solid var(--border-color);
            border-top: none;
            overflow: auto;
        }

        .tab-content.active { display: block; }

        .check-col { width: 40px; }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“ 1. å¯¼å…¥è®¢å•è¡¨ï¼ˆæ”¯æŒxlså’Œxlsxï¼‰</button>
        <input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv" onchange="handleImport(this)">
        
        <span>ç»Ÿè®¡æ—¥æœŸ:</span>
        <input type="date" id="dateInput">

        <button class="btn btn-calc" onclick="runLogic()">ğŸ“Š è®¡ç®—é€€è´§ç‡</button>
        <button class="btn btn-gray" onclick="runColorSize(true)">ğŸ•’ é¢œè‰²å°ºç (ä»Šæ—¥)</button>
        <button class="btn btn-gray" onclick="runColorSize(false)">ğŸ“… é¢œè‰²å°ºç (å…¨éƒ¨)</button>
        
        <span id="status-label">çŠ¶æ€: ç­‰å¾…å¯¼å…¥</span>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <label>è¾¾äººç­›é€‰ (æŠ–éŸ³å/uid):</label>
            <div class="tree-container">
                <table id="uidTable">
                    <thead>
                        <tr><th class="check-col">é€‰</th><th>æŠ–éŸ³å</th><th>uid</th><th>è®¢å•æ•°</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <label>å•†å“ç­›é€‰ (å•†å“å/å•†å“id):</label>
            <div class="tree-container">
                <table id="itemTable">
                    <thead>
                        <tr><th class="check-col">é€‰</th><th>å•†å“å</th><th>å•†å“id</th><th>è®¢å•æ•°</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="content">
            <div class="tabs">
                <div class="tab active" onclick="switchTab(0)">æ—¥æ€»ç»“ (Hour <= 4)</div>
                <div class="tab" onclick="switchTab(1)">æœˆæ€»ç»“ (è‡ªç„¶æœˆ)</div>
                <div class="tab" onclick="switchTab(2)">é¢œè‰²å°ºç åˆ†æ</div>
            </div>

            <div id="tabDaily" class="tab-content active">
                <table id="dailyResult">
                    <thead>
                        <tr><th>ä¸šåŠ¡æ—¥æœŸ</th><th>æ”¯ä»˜æ€»é¢</th><th>å®æ”¶</th><th>é€€è´§é¢</th><th>é€€è´§ç‡</th><th>æ‹é€€é¢</th><th>æ‹é€€ç‡</th><th>å‘é€€ç‡</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="tabMonthly" class="tab-content">
                <table id="monthlyResult">
                    <thead>
                        <tr><th>æ”¯ä»˜æœˆä»½</th><th>æ”¯ä»˜æ€»é¢</th><th>å®æ”¶</th><th>é€€è´§é¢</th><th>é€€è´§ç‡</th><th>æ‹é€€é¢</th><th>æ‹é€€ç‡</th><th>å‘é€€ç‡</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="tabColorSize" class="tab-content">
                <table id="colorSizeResult">
                    <thead>
                        <tr><th>é¢œè‰²</th><th>å°ºç </th><th>æˆäº¤æ•°é‡</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        const refundStatusList = ["é€€æ¬¾æˆåŠŸ", "å¾…æ”¶é€€è´§", "å¾…é€€è´§", "å”®åå¾…å¤„ç†"];

        // åˆå§‹åŒ–æ—¥æœŸ
        document.getElementById('dateInput').value = dayjs().format('YYYY-MM-DD');

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach((t, i) => t.classList.toggle('active', i === index));
            contents.forEach((c, i) => c.classList.toggle('active', i === index));
        }

        // æ¸…æ´— ID (å¯¹åº” clean_id)
        function cleanId(val) {
            if (val === undefined || val === null) return "";
            let s = String(val).trim();
            if (s.endsWith('.0')) s = s.slice(0, -2);
            return s || "0";
        }

        // å¯¼å…¥æ–‡ä»¶
        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                rawData = XLSX.utils.sheet_to_json(firstSheet);
                
                processFilters();
                document.getElementById('status-label').innerText = `å¯¼å…¥æˆåŠŸ: ${rawData.length} æ¡è®°å½•`;
                document.getElementById('status-label').style.color = "green";
            };
            reader.readAsArrayBuffer(file);
        }

        // ç”Ÿæˆå·¦ä¾§ç­›é€‰åˆ—è¡¨
        function processFilters() {
            const uidStats = {};
            const itemStats = {};

            rawData.forEach(row => {
                const uName = row['è¾¾äººæ˜µç§°'] || 'æœªçŸ¥';
                const uId = cleanId(row['è¾¾äººID']);
                const iName = row['é€‰è´­å•†å“'] || 'æœªçŸ¥';
                const iId = cleanId(row['å•†å“ID']);

                const uKey = `${uName}|${uId}`;
                uidStats[uKey] = (uidStats[uKey] || 0) + 1;

                const iKey = `${iName}|${iId}`;
                itemStats[iKey] = (itemStats[iKey] || 0) + 1;
            });

            fillFilterTable('uidTable', uidStats);
            fillFilterTable('itemTable', itemStats);
        }

        function fillFilterTable(tableId, stats) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            const sortedKeys = Object.keys(stats).sort((a, b) => stats[b] - stats[a]);

            sortedKeys.forEach(key => {
                const [name, id] = key.split('|');
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" value="${id}"></td>
                    <td>${name}</td>
                    <td>${id}</td>
                    <td>${stats[key]}</td>
                `;
                // ç‚¹å‡»è¡Œä¹Ÿå¯ä»¥å‹¾é€‰
                tr.onclick = (e) => {
                    if(e.target.type !== 'checkbox') {
                        const cb = tr.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                };
                tbody.appendChild(tr);
            });
        }

        // è·å–ç­›é€‰åçš„æ•°æ®
        function getFilteredData() {
            if (rawData.length === 0) return [];

            const checkedUids = Array.from(document.querySelectorAll('#uidTable input:checked')).map(i => i.value);
            const checkedItems = Array.from(document.querySelectorAll('#itemTable input:checked')).map(i => i.value);

            return rawData.filter(row => {
                const matchUid = checkedUids.length === 0 || checkedUids.includes(cleanId(row['è¾¾äººID']));
                const matchItem = checkedItems.length === 0 || checkedItems.includes(cleanId(row['å•†å“ID']));
                return matchUid && matchItem;
            });
        }

        // æ ¸å¿ƒè®¡ç®—é€»è¾‘
        function runLogic() {
            let filtered = getFilteredData();
            // è¿‡æ»¤æœªæ”¯ä»˜
            filtered = filtered.filter(row => row['æ”¯ä»˜å®Œæˆæ—¶é—´'] && String(row['æ”¯ä»˜å®Œæˆæ—¶é—´']).trim() !== "");

            if (filtered.length === 0) {
                alert("å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å·²æ”¯ä»˜çš„è®¢å•ã€‚");
                return;
            }

            // é¢„å¤„ç†å­—æ®µ
            const processed = filtered.map(row => {
                const price = parseFloat(row['å•†å“å•ä»·']) || 0;
                const discount = parseFloat(row['å•†å®¶å®é™…æ‰¿æ‹…ä¼˜æƒ é‡‘é¢']) || 0;
                const payAmt = price - discount;
                const submitTime = dayjs(row['è®¢å•æäº¤æ—¶é—´']);
                const noShip = !row['å‘è´§æ—¶é—´'] || String(row['å‘è´§æ—¶é—´']).trim() === "";
                
                return {
                    ...row,
                    payAmt,
                    submitTime,
                    // ä¸šåŠ¡æ—¥æœŸï¼šåç§» 5 å°æ—¶
                    bizDate: submitTime.subtract(5, 'hour').startOf('day').format('YYYY-MM-DD'),
                    // æœˆä»½ï¼šè‡ªç„¶æœˆ
                    submitMonth: submitTime.startOf('month').format('YYYY-MM'),
                    isRefund: refundStatusList.includes(row['å”®åçŠ¶æ€']),
                    isPaiTui: ["é€€æ¬¾æˆåŠŸ", "å”®åå¾…å¤„ç†"].includes(row['å”®åçŠ¶æ€']) && noShip
                };
            });

            // èšåˆè®¡ç®—
            renderSummary(processed, 'bizDate', 'dailyResult');
            renderSummary(processed, 'submitMonth', 'monthlyResult');
            switchTab(0);
        }

        function renderSummary(data, groupField, tableId) {
            const groups = {};
            data.forEach(row => {
                const key = row[groupField];
                if (!groups[key]) groups[key] = { p: 0, r: 0, pt: 0 };
                groups[key].p += row.payAmt;
                if (row.isRefund) groups[key].r += row.payAmt;
                if (row.isPaiTui) groups[key].pt += row.payAmt;
            });

            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            
            Object.keys(groups).sort().reverse().forEach(key => {
                const g = groups[key];
                const a = g.p - g.r;
                const rl = g.p > 0 ? (g.r / g.p * 100).toFixed(1) + '%' : '0%';
                const pal = g.p > 0 ? (g.pt / g.p * 100).toFixed(1) + '%' : '0%';
                const sal = g.p > 0 ? ((g.r - g.pt) / g.p * 100).toFixed(1) + '%' : '0%';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${key}</td>
                    <td>${g.p.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    <td>${a.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    <td>${g.r.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    <td>${rl}</td>
                    <td>${g.pt.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    <td>${pal}</td>
                    <td>${sal}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // é¢œè‰²å°ºç åˆ†æ
        function runColorSize(isToday) {
            let filtered = getFilteredData();
            filtered = filtered.filter(row => row['æ”¯ä»˜å®Œæˆæ—¶é—´']);

            if (isToday) {
                const target = document.getElementById('dateInput').value;
                filtered = filtered.filter(row => {
                    const bizDate = dayjs(row['è®¢å•æäº¤æ—¶é—´']).subtract(5, 'hour').format('YYYY-MM-DD');
                    return bizDate === target;
                });
            }

            const stats = {};
            filtered.forEach(row => {
                const spec = row['å•†å“è§„æ ¼'];
                if (!spec) return;
                
                const parts = String(spec).replace(/ï¼›/g, ';').split(';');
                const color = parts[0] ? parts[0].trim() : "æœªçŸ¥";
                const size = parts[1] ? parts[1].trim() : "å‡ç ";
                const key = `${color}|${size}`;
                stats[key] = (stats[key] || 0) + 1;
            });

            const tbody = document.querySelector('#colorSizeResult tbody');
            tbody.innerHTML = '';
            Object.keys(stats).sort((a, b) => stats[b] - stats[a]).forEach(key => {
                const [c, s] = key.split('|');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${c}</td><td>${s}</td><td>${stats[key]}</td>`;
                tbody.appendChild(tr);
            });

            switchTab(2);
        }
    </script>
</body>
</html>
